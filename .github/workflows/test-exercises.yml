name: Test Exercises

on: [push, pull_request]

jobs:
  install-sbcl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install SBCL & QuickLisp
        run: |
          sudo apt install sbcl
          curl -O http://beta.quicklisp.org/quicklisp.lisp
          sbcl --disable-debugger \
               --load quicklisp.lisp \
               --eval "(quicklisp-quickstart:install)" \
               --eval "(push (merge-pathnames \"src/\") asdf:*central-registry*)" \
               --eval "(sb-ext:save-lisp-and-die \"${HOME}/ql-sbcl\" :executable t)" \
               --quit

      - uses: actions/upload-artifact@v2
        with:
          name: sbcl-and-quicklisp
          if-no-files-found: error
          path: |
            ~/ql-sbcl
            ~/quicklisp

      - name: SBCL Version
        run: |
          ${HOME}/ql-sbcl --eval "(format t \"~A-~A\" (lisp-implementation-type) (lisp-implementation-version))"

  run-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v2
        with:
          name: sbcl-and-quicklisp
    

      - name: Run Tests
        run: |
          ${HOME}/ql-sbcl --eval "(ql:quickload \"test-exercises\")" \
                          --eval "(asdf:test-system \"test-exercises\")" \
                          --quit
